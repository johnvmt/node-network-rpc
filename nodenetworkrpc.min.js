(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.nodenetworkrpc = f()}})(function(){var define,module,exports;return (function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
function Router(){this.useRoutes=[],this.methodRoutes={},this.index=0}var UrlPattern=require("url-pattern");Router.prototype.route=function(){function t(){var r=n.shift();void 0!==r?(e.params=r.params,"function"==typeof r.handler?r.handler(e,o,t):Router._isRouter(r.handler)?r.handler.route(e.method,"/"+e.params._,e,o,t):t()):"function"==typeof a&&a()}if(3==arguments.length)var e={},o=arguments[2];else if(arguments.length>=4){var e=arguments[2];"object"==typeof e&&e||(e={});var o=arguments[3]}e.method=arguments[0];var r=arguments[1];void 0===e.path&&(e.path=r);var a=arguments[4],n=this._methodPathMatches(e.method,r);t()},Router.prototype.use=function(){var t="string"==typeof arguments[0]?arguments[0]:"",e=Router._validHandler(arguments[0])?arguments[0]:arguments[1];return this._addRouteToArray(this.useRoutes,Router._normalizePath(t),e)},Router.prototype.useFirst=function(){var t="string"==typeof arguments[0]?arguments[0]:"",e=Router._validHandler(arguments[0])?arguments[0]:arguments[1];return this._addRouteToArray(this.useRoutes,Router._normalizePath(t),e,!0)},Router.prototype.method=function(t,e,o){return this.methodRoutes[t]instanceof Array||(this.methodRoutes[t]=[]),this._addRouteToArray(this.methodRoutes[t],Router._normalizePath(e),o)},Router._validHandler=function(t){return"function"==typeof t||Router._isRouter(t)},Router._isRouter=function(t){return"object"==typeof t&&"function"==typeof t.route},Router._normalizePath=function(t){return t.replace(/\/$/,"")},Router.prototype._methodPathMatches=function(t,e){var o=Router._normalizePath(e),r=[],a=this;return a.useRoutes.forEach(function(t){var e=new UrlPattern(t.path+"(/*)").match(o);null!==e&&r.push({path:t.path,handler:t.handler,params:e})}),a.methodRoutes[t]instanceof Array&&a.methodRoutes[t].forEach(function(t){var e=new UrlPattern(t.path).match(o);null!==e&&r.push({path:t.path,handler:t.handler,params:e})}),r},Router.prototype._addRouteToArray=function(t,e,o,r){var a={path:e,handler:o};"boolean"==typeof r?t.unshift(a):t.push(a)},module.exports=function(){return new Router};
},{"url-pattern":11}],2:[function(require,module,exports){
function AgnosticRpc(){this._requests={}}var Utils=require("./Utils");AgnosticRpc.prototype.request=function(){var e=Utils.parseArgs(arguments,[{name:"query",level:0,validate:function(e,t){return void 0!==e}},{name:"options",level:1,validate:function(e,t){return"object"==typeof e},default:{}},{name:"callback",level:1,validate:function(e,t){return"function"==typeof e}}]),t={multipleResponses:!1},s=Utils.objectMerge(t,e.options);if("function"==typeof e.callback){var n=Utils.uniqueId();this._requests[n]={callback:e.callback,options:s}}var o={query:e.query};return void 0!==n&&(o.id=n),o},AgnosticRpc.prototype.handleResponse=function(e){if("string"==typeof e.id&&"object"==typeof this._requests[e.id]){var t=this._requests[e.id];"function"==typeof t.callback&&t.callback(null,e.response),t.options.multipleResponses||delete this._requests[e.id]}},AgnosticRpc.prototype.handleRequest=function(e,t,s){var n=function(t){var n={response:t};"string"==typeof e.id&&(n.id=e.id),s(n)};t(e.query,n)},AgnosticRpc.prototype.messageIsResponse=function(e){return void 0!==e.response},AgnosticRpc.prototype.messageIsRequest=function(e){return!this.messageIsResponse(e)},module.exports=function(){return new AgnosticRpc};
},{"./Utils":3}],3:[function(require,module,exports){
var Utils={};Utils.objectForEach=function(r,t){var e;for(e in r)r.hasOwnProperty(e)&&t(r[e],e,r)},Utils.objectMerge=function(){var r={};return this.objectForEach(arguments,function(t){for(var e in t)t.hasOwnProperty(e)&&(r[e]=t[e])}),r},Utils.uniqueId=function(){function r(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return r()+r()+"-"+r()+"-"+r()+"-"+r()+"-"+r()+r()+r()},Utils.parseArgs=function(r,t){function e(r,t){return"function"!=typeof r.validate||r.validate(t)}function n(r,t){for(var e=t;e<r.length;e++)if(void 0===r[e]||!r[e].required)return!0;return!1}var i={},a=0;return Array.isArray(r)||(r=Array.prototype.slice.call(r)),r.forEach(function(r,o){for(var u=a;u<t.length;u++){if(t[u].required){if(e(t[u],r)){t[u].matched=!0,i[t[u].name]=r,a++;break}throw"missing_required"}if(!t[u].required&&(n(t,u)||t[u].level>t[u-1].level&&t[u-1].matched)&&e(t[u],r)){t[u].matched=!0,i[t[u].name]=r,a++;break}t[u].matched=!1,a++}}),t.forEach(function(r){void 0===i[r.name]&&void 0!==r.default&&(i[r.name]=r.default)}),i},module.exports=Utils;
},{}],4:[function(require,module,exports){
function AddressManager(r){if(!Array.isArray(r))throw new Error("base_address_not_set");this._baseAddress=r,this._max="0",this._stringBase=36}AddressManager.prototype.allocate=function(){return this._max=this._incrementString(this._max,this._stringBase,1),this._baseAddress.concat(this._max)},AddressManager.prototype.addressIsEqual=function(r,s){if(Array.isArray(s)||(s=this._baseAddress),r.length==s.length){var e;for(e=0;e<s.length;e++)if(r[e]!=s[e])return!1;return!0}return!1},AddressManager.prototype.addressIsChild=function(r,s){if(Array.isArray(s)||(s=this._baseAddress),r.length>s.length){var e;for(e=0;e<s.length;e++)if(r[e]!=s[e])return!1;return!0}return!1},AddressManager.prototype.addressIsParent=function(r,s){return Array.isArray(s)||(s=this._baseAddress),this.addressIsChild(s,r)},AddressManager.prototype._incrementString=function(r,s,e){return(parseInt(r,s)+e).toString(s)},module.exports=function(r){return new AddressManager(r)};
},{}],5:[function(require,module,exports){
(function (process){
function NodeRouter(e){"object"!=typeof e&&(e={});var t=this;t.config=e,t._routeTable=RouteTable(),t._routeTable.on("insert",function(e){var r={address:e.address.join("-"),cost:e.cost};t.emit("insert",r)}),t._routeTable.on("remove",function(e){t.emit("remove",e.join("-"))}),t._connections={},t._connectionKeyMax=-1,t._rpc=Rpc(),process.nextTick(function(){t.setAddress(t.config.address)}),t._actions={ping:function(e,t,r){r(null,!0)},route:function(e,r,o){t._route(e,o)},addressrevoke:function(e,r,o){void 0!==t._addressManager&&t._addressManager.addressIsEqual(e)&&t._setAddressParts()},addressrequest:function(e,r,o){if("object"==typeof t._addressManager){o(null,t._addressManager.allocate())}else o("no_address",null)},routesupdate:function(e,r){if(t._routesApplyOperations(e,r),void 0===t.address){var o=function(e){return 0==e.cost},s=t._routeOperationsFilter(e,{insert:o});Array.isArray(s.insert)&&s.insert.length>0&&t.rpcRequest(r,"addressrequest",function(e,o){e?console.error("ADDREQ-FAILED",e):t._setAddressParts(o,r)})}}}}var Rpc=require("agnostic-rpc"),EventEmitter=require("wolfy87-eventemitter"),RouteTable=require("./RouteTable"),AddressManager=require("./AddressManager"),Utils=require("./Utils");NodeRouter.prototype.__proto__=EventEmitter.prototype,NodeRouter.prototype.send=function(){var e=Utils.parseArgs(arguments,[{name:"destAddressesJoined",level:0,validate:function(e,t){return"string"==typeof e||Array.isArray(e)}},{name:"message",level:0},{name:"options",level:1,validate:function(e,t){return"object"==typeof e},default:{}},{name:"callback",level:1,validate:function(e,t){return"function"==typeof e}}]),t=Array.isArray(e.destAddressesJoined)?e.destAddressesJoined:[e.destAddressesJoined],r=[];t.forEach(function(e){r.push(e.split("-"))}),this._route({message:e.message,dest:r},e.callback)},NodeRouter.prototype.setAddress=function(e,t){if("string"==typeof e){var r=e.split("-");return this._setAddressParts(r,t)}return!1},NodeRouter.prototype._broadcastRouteOperations=function(e){var t=this;Utils.objectForEach(t._connections,function(r,o){t.rpcRequest(o,"routesupdate",e)})},NodeRouter.prototype._routesApplyOperations=function(e,t){var r=this,o=JSON.parse(JSON.stringify(e)),s=function(e){return void 0===r._addressManager||!r._addressManager.addressIsEqual(e.address)},n=r._routeOperationsFilter(o,{insert:s});Array.isArray(n.insert)&&n.insert.forEach(function(e){e.cost=e.cost+1});var a=r._routeTable.modifyRoutes(n,t),s=function(e){return void 0!==r._addressManager&&!r._addressManager.addressIsChild(e.address)};localOperationsBroadcast=r._routeOperationsFilter(a,{insert:s}),Object.keys(localOperationsBroadcast).length&&r._broadcastRouteOperations(localOperationsBroadcast)},NodeRouter.prototype._setAddressParts=function(e,t){var r=this,o={};if(void 0!==r.address){o.remove=[r.address];var s=r._routeTable.childRoutes(this.address);"object"==typeof s&&Utils.objectForEach(s,function(e,t){var o=r.address.concat(t);r._routeTable.removeRoute(o,e.connectionKey),r.rpcRequest(e.connectionKey,"addressrevoke",o)})}r.address=e,r.addressConnectionKey=t,r._addressManager=void 0,void 0!==r.address&&(r._addressManager=AddressManager(r.address),o.insert=[{address:r.address,cost:0}]),Object.keys(o).length&&r._broadcastRouteOperations(o),r.emit("addressParts",r.address);var n=Array.isArray(this.address)?r.address.join("-"):void 0;r.emit("address",n)},NodeRouter.prototype.connectionRouteTableOperations=function(e){var t=this,r=function(r,o){return r.connection!=e&&("object"!=typeof t._addressManager||!t._addressManager.addressIsChild(o))},o=t._routeTable.toRouteOperations(r);return void 0!==t.address&&(Array.isArray(o.insert)||(o.insert=[]),o.insert.push({address:t.address,cost:0})),o},NodeRouter.prototype.addConnection=function(e,t){function r(){var t=o.connectionRouteTableOperations(e);o.rpcRequest(s,"routesupdate",t)}var o=this;o._connectionKeyMax++;var s=o._connectionKeyMax;"object"==typeof t&&null!=t||(t={}),o._connections[s]={connection:e,options:t},e.on("data",function(e){try{o._rpcMessage(s,e)}catch(e){console.error(e)}}),e.on("disconnect",function(){o.addressConnectionKey==s&&o._setAddressParts();var e=o._routeTable.removeConnectionRoutes(s);o._broadcastRouteOperations(e),delete o._connections[s]}),e.on("connect",function(){o._connections[s]={connection:e,options:t},r()}),r()},NodeRouter.prototype._routeOperationsFilter=function(e,t){var r={};return Utils.objectForEach(e,function(e,o){if(Array.isArray(e))if("function"==typeof t[o]){var s=e.filter(t[o]);Array.isArray(s)&&s.length>0&&(r[o]=s)}else r[o]=e}),r},NodeRouter.prototype.rpcBroadcast=function(){var e=this,t=Array.prototype.slice.call(arguments);Utils.objectForEach(e._connections,function(r,o){e.rpcRequest.apply(e,[o].concat(t))})},NodeRouter.prototype.rpcRequest=function(){var e=Utils.parseArgs(arguments,[{name:"connectionKey",level:0},{name:"action",level:0,validate:function(e,t){return"string"==typeof e}},{name:"query",level:1,validate:function(e,t){return"object"==typeof e},default:{}},{name:"callback",level:1,validate:function(e,t){return"function"==typeof e}}]),t=this._rpc.request({action:e.action,query:e.query},function(t,r){"function"==typeof e.callback&&(t?e.callback(t,null):"string"==typeof r.status&&"ok"==r.status?e.callback(null,r.response):"string"==typeof r.status&&e.callback(r.error,r.response))});this._connections[e.connectionKey].connection.emit("data",t)},NodeRouter.prototype._route=function(e,t){function r(){"function"==typeof t&&t.apply(this,Array.prototype.slice.call(arguments))}var o=this,s={};Array.isArray(e.dest)?(e.dest.forEach(function(t){if("object"==typeof o._addressManager&&o._addressManager.addressIsEqual(t))o.emit("data",e),o.emit("message",e.message),r(null,o.address);else{var n=o._routeTable.nextConnection(t);void 0!==n?(Array.isArray(s[n])||(s[n]=[]),s[n].push(t)):r("no_route",null)}}),Utils.objectForEach(s,function(r,s){e.dest=r,o.rpcRequest(s,"route",e,t)})):r("improper_route_format",null)},NodeRouter.prototype._rpcMessage=function(e,t){var r=this;if(r._rpc.messageIsResponse(t))r._rpc.handleResponse(t);else{var o=r._actions;r._rpc.handleRequest(t,function(t,r){var s=function(e,t){r(e?{status:"error",error:e,response:t}:{status:"ok",response:t})};"string"==typeof t.action&&"function"==typeof o[t.action]?o[t.action](t.query,e,s):s("action_not_found",null)},function(t){if(r._connections[e]){r._connections[e].connection.emit("data",t)}})}},module.exports=function(e){return new NodeRouter(e)};
}).call(this,require('_process'))

},{"./AddressManager":4,"./RouteTable":6,"./Utils":8,"_process":9,"agnostic-rpc":2,"wolfy87-eventemitter":12}],6:[function(require,module,exports){
function RouteTable(){this.table=Tree()}var Utils=require("./Utils"),Tree=require("./Trie"),EventEmitter=require("wolfy87-eventemitter");RouteTable.prototype.toRouteOperations=function(e){var t=[];return this.table.traverse(function(r,o){("function"!=typeof e||e(r,o))&&t.push({address:o,cost:r.cost})}),0==t.length?{}:{insert:t}},RouteTable.prototype.__proto__=EventEmitter.prototype,RouteTable.prototype.childRoutes=function(e){return this.table.children(e)},RouteTable.prototype.nextConnection=function(e){var t=this.table.deepest(e);return"object"==typeof t?t.data.connectionKey:void 0},RouteTable.prototype.removeConnectionRoutes=function(e){var t=[];return this.table.traverse(function(r,o){r.connectionKey==e&&t.push(o)}),this.modifyRoutes({remove:t},e)},RouteTable.prototype.modifyRoutes=function(e,t){var r=this,o={};return Array.isArray(e.remove)&&e.remove.forEach(function(e){Array.isArray(e)&&r.removeRoute(e,t)&&(Array.isArray(o.remove)||(o.remove=[]),o.remove.indexOf(e)<0&&o.remove.push(e),r.emit("remove",e))}),Array.isArray(e.insert)&&e.insert.forEach(function(e){Array.isArray(e.address)&&"number"==typeof e.cost&&r.insertRoute(e.address,t,e.cost)&&(Array.isArray(o.insert)||(o.insert=[]),o.insert.indexOf(e)<0&&o.insert.push(e),r.emit("insert",e))}),o},RouteTable.prototype.insertRoute=function(e,t,r){var o=this.table.get(e);return(void 0===o||o.cost>r||o.connectionKey==t)&&(this.table.set(e,{cost:r,connectionKey:t}),!0)},RouteTable.prototype.removeRoute=function(e,t){var r=this.table.get(e);return"object"==typeof r&&r.connectionKey==t&&this.table.remove(e)},module.exports=function(){return new RouteTable};
},{"./Trie":7,"./Utils":8,"wolfy87-eventemitter":12}],7:[function(require,module,exports){
function Trie(){this.trie={}}var Utils=require("./Utils");Trie.prototype.get=function(e){var t=this.getNode(e);return"object"==typeof t&&void 0!==t.data?t.data:void 0},Trie.prototype.getNode=function(e){var t=this.trie;for(var r in e){if("object"!=typeof t.children||"object"!=typeof t.children[e[r]])return;t=t.children[e[r]]}return t},Trie.prototype.set=function(e,t){var r=this.trie;for(var o in e)"object"!=typeof r.children&&(r.children={}),"object"!=typeof r.children[e[o]]&&(r.children[e[o]]={}),r=r.children[e[o]];r.data=t},Trie.prototype.remove=function(e){var t=this.inPathNodes(e);if(t.length!=e.length+1)return!1;var r=t.pop();if(delete r.node.data,"object"==typeof r.node.children&&Object.keys(r.node.children).length>0)return!0;r.path.length>0&&delete t[t.length-1].node.children[r.path.pop()];for(var o=t.length-1;o>=0;o--){if("object"==typeof t[o].node.children&&0==Object.keys(t[o].node.children).length&&delete t[o].node.children,void 0!==t[o].node.data||"object"==typeof t[o].node.children&&Object.keys(t[o].node.children).length>0)return!0;o>0&&delete t[o-1].node.children[t[o].path.pop()]}return!0},Trie.prototype.removeNode=function(e){var t=this.inPathNodes(e);if(t.length!=e.length+1)return!1;var r=t.pop();delete r.node.data,r.path.length>0&&delete t[t.length-1].node.children[r.path.pop()];for(var o=t.length-1;o>=0;o--){if("object"==typeof t[o].node.children&&0==Object.keys(t[o].node.children).length&&delete t[o].node.children,void 0!==t[o].node.data||"object"==typeof t[o].node.children&&Object.keys(t[o].node.children).length>0)return!0;void 0!==t[o-1]&&delete t[o-1].node.children[t[o].path.pop()]}return!0},Trie.prototype.children=function(e){var t=this.childrenNodes(e);if(void 0!==t){var r={};return Utils.objectForEach(t,function(e,t){void 0!==e.data&&(r[t]=e.data)}),r}},Trie.prototype.childrenNodes=function(e){var t=this.getNode(e);return"object"!=typeof t?void 0:"object"!=typeof t.children?{}:t.children},Trie.prototype.traverse=function(e,t,r){this.traverseNodes(function(t,r){void 0!==t.data&&e(t.data,r)},t,r)},Trie.prototype.traverseNodes=function(e,t,r){if(!Array.isArray(r))var r=[];if("object"!=typeof t)var t=this.trie;if(e(t,r),t.children,!0){var o;for(o in t.children)t.children.hasOwnProperty(o)&&this.traverseNodes(e,t.children[o],r.concat(o))}},Trie.prototype.deepest=function(e){var t=void 0,r=void 0;return this.descend(e,function(e,o){t=e,r=o}),void 0===r?void 0:{pathKeys:r,data:t}},Trie.prototype.descend=function(e,t){this.descendNodes(e,function(e,r){void 0!==e.data&&t(e.data,r)})},Trie.prototype.descendNodes=function(e,t){var r=this.trie;t(r,[]);for(var o=0;o<e.length;o++){if("object"!=typeof r.children||"object"!=typeof r.children[e[o]])return;r=r.children[e[o]],t(r,e.slice(0,o+1))}},Trie.prototype.inPathNodes=function(e){var t=[];return this.descend(e,function(e,r){t.push({path:r,data:e})}),t},Trie.prototype.inPathNodes=function(e){var t=[];return this.descendNodes(e,function(e,r){t.push({path:r,node:e})}),t},module.exports=function(){return new Trie};
},{"./Utils":8}],8:[function(require,module,exports){
var Utils={};Utils.objectFilterProperties=function(e,t){var n={};return t.forEach(function(t){n[t]=e[t]}),n},Utils.objectContainsObject=function(e,t){for(var n in t)if(t.hasOwnProperty(n)&&(!e.hasOwnProperty(n)||e[n]!=t[n]))return!1;return!0},Utils.objectFilter=function(e,t){var n={};return this.objectForEach(e,function(e,r,i){t(e,r,i)&&(n[r]=e)}),n},Utils.objectForEach=function(e,t){var n;for(n in e)e.hasOwnProperty(n)&&t(e[n],n,e)},Utils.objectGet=function(e,t){var n=this;if(0==t.length)return e;if("object"==typeof e){if(("string"==typeof t[0]||"number"==typeof t[0])&&null!==e&&e.hasOwnProperty(t[0]))return this.objectGet(e[t[0]],t.slice(1));if(null===t[0]){if(Array.isArray(e)){var r=[];e.forEach(function(e,i){r[i]=n.objectGet(e,t.slice(1))})}else{var r={};this.objectForEach(e,function(e,i){r[i]=n.objectGet(e,t.slice(1))})}return r}if(t[0]instanceof RegExp){var r={};return this.objectForEach(e,function(e,i){i.match(t[0])&&(r[i]=n.objectGet(e,t.slice(1)))}),r}if("function"==typeof t[0]){if(e instanceof Array){var r=[];e.forEach(function(e,i,o){t[0](e,i,o)&&(r[i]=n.objectGet(e,t.slice(1)))})}else{var r={};this.objectForEach(n.objectFilter(e,t[0]),function(e,i){r[i]=n.objectGet(e,t.slice(1))})}return r}if(t[0]instanceof Array){if(e instanceof Array){var r=[];t[0].forEach(function(t,n){r[n]=e[n]})}else{var r={};this.objectForEach(n.objectFilterProperties(e,t[0]),function(e,i){r[i]=n.objectGet(e,t.slice(1))})}return r}}},Utils.objectSet=function(e,t,n){return 1==t.length?(e[t[0]]=n,!0):(void 0===e[t[0]]&&(e[t[0]]={}),this._objectSet(e[t[0]],t.slice(1),n))},Utils.objectIsset=function(e,t){return 1==t.length?void 0!==e[t[0]]:void 0!==e[t[0]]&&this.objectIsset(e[t[0]],t.slice(1))},Utils.objectMerge=function(){var e={};return this.objectForEach(arguments,function(t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}),e},Utils.uniqueId=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},Utils.parseArgs=function(e,t){function n(e,t){return"function"!=typeof e.validate||e.validate(t)}function r(e,t){for(var n=t;n<e.length;n++)if(void 0===e[n]||!e[n].required)return!0;return!1}var i={},o=0;return Array.isArray(e)||(e=Array.prototype.slice.call(e)),e.forEach(function(e,c){for(var a=o;a<t.length;a++){if(t[a].required){if(n(t[a],e)){t[a].matched=!0,i[t[a].name]=e,o++;break}throw"missing_required"}if(!t[a].required&&(r(t,a)||t[a].level>t[a-1].level&&t[a-1].matched)&&n(t[a],e)){t[a].matched=!0,i[t[a].name]=e,o++;break}t[a].matched=!1,o++}}),t.forEach(function(e){void 0===i[e.name]&&void 0!==e.default&&(i[e.name]=e.default)}),i},Utils.callbackQueue=function(){function e(){r||(r=!0,n.queueCompleteCallback.apply(this,Array.prototype.slice.call(arguments)))}function t(){i++,"function"==typeof n.queueFunctions[i]?Array.isArray(n.queueFunctionArgs)&&!n.options.expand?n.queueFunctions[i](n.queueFunctionArgs,t,e):Array.isArray(n.queueFunctionArgs)&&n.options.expand?n.queueFunctions[i].apply(this,n.queueFunctionArgs.concat([t,e])):n.queueFunctions[i](t,e):"function"!=typeof n.queueNoMatchCallback||r||n.queueNoMatchCallback()}var n=Utils.parseArgs(arguments,[{name:"queueFunctions",level:0,validate:function(e,t){return Array.isArray(e)}},{name:"queueFunctionArgs",level:1,validate:function(e,t){return Array.isArray(e)}},{name:"queueCompleteCallback",level:0,validate:function(e,t){return"function"==typeof e}},{name:"queueNoMatchCallback",level:1,validate:function(e,t){return"function"==typeof e}},{name:"options",level:1,validate:function(e,t){return"object"==typeof e},default:{}}]);n.options=Utils.objectMerge({expand:!1},n.options);var r=!1,i=-1;t()},module.exports=Utils;
},{}],9:[function(require,module,exports){
function defaultSetTimout(){throw new Error("setTimeout has not been defined")}function defaultClearTimeout(){throw new Error("clearTimeout has not been defined")}function runTimeout(e){if(cachedSetTimeout===setTimeout)return setTimeout(e,0);if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout)return cachedSetTimeout=setTimeout,setTimeout(e,0);try{return cachedSetTimeout(e,0)}catch(t){try{return cachedSetTimeout.call(null,e,0)}catch(t){return cachedSetTimeout.call(this,e,0)}}}function runClearTimeout(e){if(cachedClearTimeout===clearTimeout)return clearTimeout(e);if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout)return cachedClearTimeout=clearTimeout,clearTimeout(e);try{return cachedClearTimeout(e)}catch(t){try{return cachedClearTimeout.call(null,e)}catch(t){return cachedClearTimeout.call(this,e)}}}function cleanUpNextTick(){draining&&currentQueue&&(draining=!1,currentQueue.length?queue=currentQueue.concat(queue):queueIndex=-1,queue.length&&drainQueue())}function drainQueue(){if(!draining){var e=runTimeout(cleanUpNextTick);draining=!0;for(var t=queue.length;t;){for(currentQueue=queue,queue=[];++queueIndex<t;)currentQueue&&currentQueue[queueIndex].run();queueIndex=-1,t=queue.length}currentQueue=null,draining=!1,runClearTimeout(e)}}function Item(e,t){this.fun=e,this.array=t}function noop(){}var process=module.exports={},cachedSetTimeout,cachedClearTimeout;!function(){try{cachedSetTimeout="function"==typeof setTimeout?setTimeout:defaultSetTimout}catch(e){cachedSetTimeout=defaultSetTimout}try{cachedClearTimeout="function"==typeof clearTimeout?clearTimeout:defaultClearTimeout}catch(e){cachedClearTimeout=defaultClearTimeout}}();var queue=[],draining=!1,currentQueue,queueIndex=-1;process.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];queue.push(new Item(e,t)),1!==queue.length||draining||runTimeout(drainQueue)},Item.prototype.run=function(){this.fun.apply(null,this.array)},process.title="browser",process.browser=!0,process.env={},process.argv=[],process.version="",process.versions={},process.on=noop,process.addListener=noop,process.once=noop,process.off=noop,process.removeListener=noop,process.removeAllListeners=noop,process.emit=noop,process.prependListener=noop,process.prependOnceListener=noop,process.listeners=function(e){return[]},process.binding=function(e){throw new Error("process.binding is not supported")},process.cwd=function(){return"/"},process.chdir=function(e){throw new Error("process.chdir is not supported")},process.umask=function(){return 0};
},{}],10:[function(require,module,exports){
function QueueEmitter(){}var EventEmitter=require("wolfy87-eventemitter");QueueEmitter.prototype.__proto__=EventEmitter.prototype,QueueEmitter.prototype.emit=function(){var t=this,e=Array.prototype.slice.call(arguments),o=e.shift(),i=e.pop(),n=t.getListeners(o),r=[];n.forEach(function(t){r.push(t.listener)}),this._callbackQueue(r,e,function(e){n.filter(function(t){return t.once}).forEach(function(e){t.off(o,e.listener)}),"function"==typeof i&&i(void 0===e?null:e)})},QueueEmitter.prototype._callbackQueue=function(t,e,o){function i(r){n++,void 0!==r||"function"!=typeof t[n]?o(r):t[n].apply(this,e.concat([i]))}var n=-1;i()},module.exports=QueueEmitter;
},{"wolfy87-eventemitter":12}],11:[function(require,module,exports){
var slice=[].slice;!function(e,r){"function"==typeof define&&null!=define.amd?define([],r):"undefined"!=typeof exports&&null!==exports?module.exports=r():e.UrlPattern=r()}(this,function(){var e,r,t,n,a,i,s,u,o,l,c,g,f,h,m;return o=function(e){return e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")},s=function(e,r){var t,n,a;for(a=[],t=-1,n=e.length;++t<n;)a=a.concat(r(e[t]));return a},h=function(e,r){var t,n,a;for(a="",t=-1,n=e.length;++t<n;)a+=r(e[t]);return a},f=function(e){return new RegExp(e.toString()+"|").exec("").length-1},c=function(e,r){var t,n,a,i,s;for(i={},t=-1,a=e.length;++t<a;)n=e[t],null!=(s=r[t])&&(null!=i[n]?(Array.isArray(i[n])||(i[n]=[i[n]]),i[n].push(s)):i[n]=s);return i},e={},e.Result=function(e,r){this.value=e,this.rest=r},e.Tagged=function(e,r){this.tag=e,this.value=r},e.tag=function(r,t){return function(n){var a,i;if(null!=(a=t(n)))return i=new e.Tagged(r,a.value),new e.Result(i,a.rest)}},e.regex=function(r){return function(t){var n,a;if(null!=(n=r.exec(t)))return a=n[0],new e.Result(a,t.slice(a.length))}},e.sequence=function(){var r;return r=1<=arguments.length?slice.call(arguments,0):[],function(t){var n,a,i,s,u,o;for(n=-1,a=r.length,o=[],s=t;++n<a;){if(i=r[n],null==(u=i(s)))return;o.push(u.value),s=u.rest}return new e.Result(o,s)}},e.pick=function(){var r,t;return r=arguments[0],t=2<=arguments.length?slice.call(arguments,1):[],function(n){var a,i;if(null!=(i=e.sequence.apply(e,t)(n)))return a=i.value,i.value=a[r],i}},e.string=function(r){var t;return t=r.length,function(n){if(n.slice(0,t)===r)return new e.Result(r,n.slice(t))}},e.lazy=function(e){var r;return r=null,function(t){return null==r&&(r=e()),r(t)}},e.baseMany=function(r,t,n,a,i){var s,u,o;for(u=i,o=n?"":[];;){if(null!=t&&null!=t(u))break;if(null==(s=r(u)))break;n?o+=s.value:o.push(s.value),u=s.rest}if(!a||0!==o.length)return new e.Result(o,u)},e.many1=function(r){return function(t){return e.baseMany(r,null,!1,!0,t)}},e.concatMany1Till=function(r,t){return function(n){return e.baseMany(r,t,!0,!0,n)}},e.firstChoice=function(){var e;return e=1<=arguments.length?slice.call(arguments,0):[],function(r){var t,n,a,i;for(t=-1,n=e.length;++t<n;)if(a=e[t],null!=(i=a(r)))return i}},g=function(r){var t;return t={},t.wildcard=e.tag("wildcard",e.string(r.wildcardChar)),t.optional=e.tag("optional",e.pick(1,e.string(r.optionalSegmentStartChar),e.lazy(function(){return t.pattern}),e.string(r.optionalSegmentEndChar))),t.name=e.regex(new RegExp("^["+r.segmentNameCharset+"]+")),t.named=e.tag("named",e.pick(1,e.string(r.segmentNameStartChar),e.lazy(function(){return t.name}))),t.escapedChar=e.pick(1,e.string(r.escapeChar),e.regex(/^./)),t.static=e.tag("static",e.concatMany1Till(e.firstChoice(e.lazy(function(){return t.escapedChar}),e.regex(/^./)),e.firstChoice(e.string(r.segmentNameStartChar),e.string(r.optionalSegmentStartChar),e.string(r.optionalSegmentEndChar),t.wildcard))),t.token=e.lazy(function(){return e.firstChoice(t.wildcard,t.optional,t.named,t.static)}),t.pattern=e.many1(e.lazy(function(){return t.token})),t},u={escapeChar:"\\",segmentNameStartChar:":",segmentValueCharset:"a-zA-Z0-9-_~ %",segmentNameCharset:"a-zA-Z0-9",optionalSegmentStartChar:"(",optionalSegmentEndChar:")",wildcardChar:"*"},i=function(e,r){if(Array.isArray(e))return h(e,function(e){return i(e,r)});switch(e.tag){case"wildcard":return"(.*?)";case"named":return"(["+r+"]+)";case"static":return o(e.value);case"optional":return"(?:"+i(e.value,r)+")?"}},a=function(e,r){return null==r&&(r=u.segmentValueCharset),"^"+i(e,r)+"$"},n=function(e){if(Array.isArray(e))return s(e,n);switch(e.tag){case"wildcard":return["_"];case"named":return[e.value];case"static":return[];case"optional":return n(e.value)}},l=function(e,r,t,n){var a,i,s,u;if(null==n&&(n=!1),null!=(u=e[r])){if(a=t[r]||0,i=Array.isArray(u)?u.length-1:0,!(a>i))return s=Array.isArray(u)?u[a]:u,n&&(t[r]=a+1),s;if(n)throw new Error("too few values provided for key `"+r+"`")}else if(n)throw new Error("no values provided for key `"+r+"`")},t=function(e,r,n){var a,i;if(Array.isArray(e)){for(a=-1,i=e.length;++a<i;)if(t(e[a],r,n))return!0;return!1}switch(e.tag){case"wildcard":return null!=l(r,"_",n,!1);case"named":return null!=l(r,e.value,n,!1);case"static":return!1;case"optional":return t(e.value,r,n)}},m=function(e,r,n){if(Array.isArray(e))return h(e,function(e){return m(e,r,n)});switch(e.tag){case"wildcard":return l(r,"_",n,!0);case"named":return l(r,e.value,n,!0);case"static":return e.value;case"optional":return t(e.value,r,n)?m(e.value,r,n):""}},r=function(e,t){var i,s,o,l;if(e instanceof r)return this.isRegex=e.isRegex,this.regex=e.regex,this.ast=e.ast,void(this.names=e.names);if(this.isRegex=e instanceof RegExp,"string"!=typeof e&&!this.isRegex)throw new TypeError("argument must be a regex or a string");if(this.isRegex){if(this.regex=e,null!=t){if(!Array.isArray(t))throw new Error("if first argument is a regex the second argument may be an array of group names but you provided something else");if(i=f(this.regex),t.length!==i)throw new Error("regex contains "+i+" groups but array of group names contains "+t.length);this.names=t}}else{if(""===e)throw new Error("argument must not be the empty string");if(e.replace(/\s+/g,"")!==e)throw new Error("argument must not contain whitespace");if(s={escapeChar:(null!=t?t.escapeChar:void 0)||u.escapeChar,segmentNameStartChar:(null!=t?t.segmentNameStartChar:void 0)||u.segmentNameStartChar,segmentNameCharset:(null!=t?t.segmentNameCharset:void 0)||u.segmentNameCharset,segmentValueCharset:(null!=t?t.segmentValueCharset:void 0)||u.segmentValueCharset,optionalSegmentStartChar:(null!=t?t.optionalSegmentStartChar:void 0)||u.optionalSegmentStartChar,optionalSegmentEndChar:(null!=t?t.optionalSegmentEndChar:void 0)||u.optionalSegmentEndChar,wildcardChar:(null!=t?t.wildcardChar:void 0)||u.wildcardChar},l=g(s),null==(o=l.pattern(e)))throw new Error("couldn't parse pattern");if(""!==o.rest)throw new Error("could only partially parse pattern");this.ast=o.value,this.regex=new RegExp(a(this.ast,s.segmentValueCharset)),this.names=n(this.ast)}},r.prototype.match=function(e){var r,t;return null==(t=this.regex.exec(e))?null:(r=t.slice(1),this.names?c(this.names,r):r)},r.prototype.stringify=function(e){if(null==e&&(e={}),this.isRegex)throw new Error("can't stringify patterns generated from a regex");if(e!==Object(e))throw new Error("argument must be an object or undefined");return m(this.ast,e,{})},r.escapeForRegex=o,r.concatMap=s,r.stringConcatMap=h,r.regexGroupCount=f,r.keysAndValuesToObject=c,r.P=e,r.newParser=g,r.defaultOptions=u,r.astNodeToRegexString=a,r.astNodeToNames=n,r.getParam=l,r.astNodeContainsSegmentsForProvidedParams=t,r.stringify=m,r});
},{}],12:[function(require,module,exports){
!function(e){"use strict";function t(){}function n(e,t){for(var n=e.length;n--;)if(e[n].listener===t)return n;return-1}function r(e){return function(){return this[e].apply(this,arguments)}}function i(e){return"function"==typeof e||e instanceof RegExp||!(!e||"object"!=typeof e)&&i(e.listener)}var s=t.prototype,o=e.EventEmitter;s.getListeners=function(e){var t,n,r=this._getEvents();if(e instanceof RegExp){t={};for(n in r)r.hasOwnProperty(n)&&e.test(n)&&(t[n]=r[n])}else t=r[e]||(r[e]=[]);return t},s.flattenListeners=function(e){var t,n=[];for(t=0;t<e.length;t+=1)n.push(e[t].listener);return n},s.getListenersAsObject=function(e){var t,n=this.getListeners(e);return n instanceof Array&&(t={},t[e]=n),t||n},s.addListener=function(e,t){if(!i(t))throw new TypeError("listener must be a function");var r,s=this.getListenersAsObject(e),o="object"==typeof t;for(r in s)s.hasOwnProperty(r)&&-1===n(s[r],t)&&s[r].push(o?t:{listener:t,once:!1});return this},s.on=r("addListener"),s.addOnceListener=function(e,t){return this.addListener(e,{listener:t,once:!0})},s.once=r("addOnceListener"),s.defineEvent=function(e){return this.getListeners(e),this},s.defineEvents=function(e){for(var t=0;t<e.length;t+=1)this.defineEvent(e[t]);return this},s.removeListener=function(e,t){var r,i,s=this.getListenersAsObject(e);for(i in s)s.hasOwnProperty(i)&&-1!==(r=n(s[i],t))&&s[i].splice(r,1);return this},s.off=r("removeListener"),s.addListeners=function(e,t){return this.manipulateListeners(!1,e,t)},s.removeListeners=function(e,t){return this.manipulateListeners(!0,e,t)},s.manipulateListeners=function(e,t,n){var r,i,s=e?this.removeListener:this.addListener,o=e?this.removeListeners:this.addListeners;if("object"!=typeof t||t instanceof RegExp)for(r=n.length;r--;)s.call(this,t,n[r]);else for(r in t)t.hasOwnProperty(r)&&(i=t[r])&&("function"==typeof i?s.call(this,r,i):o.call(this,r,i));return this},s.removeEvent=function(e){var t,n=typeof e,r=this._getEvents();if("string"===n)delete r[e];else if(e instanceof RegExp)for(t in r)r.hasOwnProperty(t)&&e.test(t)&&delete r[t];else delete this._events;return this},s.removeAllListeners=r("removeEvent"),s.emitEvent=function(e,t){var n,r,i,s,o=this.getListenersAsObject(e);for(s in o)if(o.hasOwnProperty(s))for(n=o[s].slice(0),i=0;i<n.length;i++)r=n[i],!0===r.once&&this.removeListener(e,r.listener),r.listener.apply(this,t||[])===this._getOnceReturnValue()&&this.removeListener(e,r.listener);return this},s.trigger=r("emitEvent"),s.emit=function(e){var t=Array.prototype.slice.call(arguments,1);return this.emitEvent(e,t)},s.setOnceReturnValue=function(e){return this._onceReturnValue=e,this},s._getOnceReturnValue=function(){return!this.hasOwnProperty("_onceReturnValue")||this._onceReturnValue},s._getEvents=function(){return this._events||(this._events={})},t.noConflict=function(){return e.EventEmitter=o,t},"function"==typeof define&&define.amd?define(function(){return t}):"object"==typeof module&&module.exports?module.exports=t:e.EventEmitter=t}(this||{});
},{}],13:[function(require,module,exports){
function NodeNetworkRpc(e){var t=this;t.connected=!1,t._queueEmitter=new QueueEmitter,t.network=NodeNetwork(e),t.router=AgnosticRouter(),t._rpc=Rpc(),t.network.on("message",function(e){t._rpcMessage(e)}),t.network.on("address",function(e){t.address=e,void 0===e?(t.connected=!1,t.emit("disconnect")):(t.connected=!0,t.emit("connect"))}),["insert","remove"].forEach(function(e){t.network.on(e,function(){t.emit(e,Array.prototype.slice.call(arguments))})});var o={};this.config=Utils.objectMerge(o,e)}var Rpc=require("agnostic-rpc"),EventEmitter=require("wolfy87-eventemitter"),QueueEmitter=require("queue-emitter"),AgnosticRouter=require("agnostic-router"),NodeNetwork=require("node-network"),Utils=require("./Utils.js");NodeNetworkRpc.prototype.__proto__=EventEmitter.prototype,NodeNetworkRpc.prototype.queueOn=function(){this._queueEmitter.on.apply(this._queueEmitter,Array.prototype.slice.call(arguments))},NodeNetworkRpc.prototype.queueOnce=function(){this._queueEmitter.once.apply(this._queueEmitter,Array.prototype.slice.call(arguments))},NodeNetworkRpc.prototype.request=function(){var e=this;if(void 0===e.address){var t=Array.prototype.slice.call(arguments);e.once("connect",function(){e.request.apply(e,t)})}else{var o=Utils.parseArgs(arguments,[{name:"destAddresses",level:1,validate:function(e,t){return"string"==typeof e&&"/"!=e[0]||Array.isArray(e)}},{name:"path",level:0,validate:function(e,t){return"string"==typeof e&&"/"==e[0]}},{name:"query",level:1,validate:function(e,t){return"object"==typeof e},default:{}},{name:"options",level:2,validate:function(e,t){return"object"==typeof e},default:{}},{name:"callback",level:1,validate:function(e,t){return"function"==typeof e}}]),r={query:{path:o.path,query:o.query,srcAddress:this.address},options:o.options};"function"==typeof o.callback?r.responseHandler=function(e,t){"function"==typeof o.callback&&(e?o.callback(e):"object"!=typeof t?o.callback("response_not_object"):o.callback(t.error,t.response))}:r.responseHandler=void 0,r.destAddresses=e.network.normalizeAddresses(o.destAddresses),e._queueEmitter.emit("outgoingRequest",r,function(t){if(t)"function"==typeof r.responseHandler&&r.responseHandler(t);else{var o=e._rpc.request(r.query,r.options,r.responseHandler);e.network.send(r.destAddresses,o)}})}},NodeNetworkRpc.prototype._rpcMessage=function(e){var t=this;t._rpc.messageIsResponse(e)?t._queueEmitter.emit("incomingResponse",e,function(o){t._rpc.handleResponse(e)}):t._queueEmitter.emit("incomingRequest",e,function(o){var r=void 0,n=function(e,o){r=e.srcAddress;var n=function(e,t){o({error:e,response:t})},s=function(){n("not_found",null)};t.router.route("request",e.path,e,n,s)},s=function(e){var o={destAddress:r,message:e};t._queueEmitter.emit("outgoingResponse",o,function(e){e||t.network.send(o.destAddress,o.message)})};t._rpc.handleRequest(e,n,s)})},NodeNetworkRpc.prototype.addConnection=function(e){this.network.addConnection.apply(this.network,Array.prototype.slice.call(arguments))},module.exports=function(e){return new NodeNetworkRpc(e)};
},{"./Utils.js":14,"agnostic-router":1,"agnostic-rpc":2,"node-network":5,"queue-emitter":10,"wolfy87-eventemitter":12}],14:[function(require,module,exports){
arguments[4][8][0].apply(exports,arguments)
},{"dup":8}]},{},[13])(13)
});


//# sourceMappingURL=nodenetworkrpc.js.map